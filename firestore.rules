rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions to improve readability and reuse of logic.

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * This is the core function for enforcing user ownership.
     * @param userId The user ID from the document path.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Validates that the User document being created has an 'id' field
     * matching the document's ID, ensuring path and data consistency.
     */
    function hasValidUserDataOnCreate(userId) {
      return request.resource.data.id == userId;
    }
    
    /**
     * Enforces immutability of the critical 'id' and 'email' fields in a User document.
     */
    function isUserDataImmutable() {
      return request.resource.data.id == resource.data.id &&
             request.resource.data.email == resource.data.email;
    }

    /**
     * Validates that a subcollection document being created has a 'userId' field
     * matching the parent user's ID, ensuring relational integrity.
     */
    function hasValidSubcollectionDataOnCreate(userId) {
      return request.resource.data.userId == userId;
    }

    /**
     * Enforces immutability of the 'userId' field in subcollection documents.
     * This prevents documents from being reassigned to a different user.
     */
    function isSubcollectionDataImmutable() {
      return request.resource.data.userId == resource.data.userId;
    }

    /**
     * @description Manages user profile documents.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId) && hasValidUserDataOnCreate(userId);
      allow update: if isOwner(userId) && isUserDataImmutable();
      allow delete: if false; // Generally, users shouldn't delete their own accounts directly.

      /**
       * @description Manages a user's transactions (income and expenses).
       * @path /users/{userId}/transactions/{transactionId}
       */
      match /transactions/{transactionId} {
        allow read, list, create, update, delete: if isOwner(userId)
            && (
                (request.method == 'create' && hasValidSubcollectionDataOnCreate(userId)) ||
                (request.method == 'update' && isSubcollectionDataImmutable()) ||
                (request.method in ['get', 'list', 'delete'])
            );
      }

      /**
       * @description Manages a user's personal budget records.
       * @path /users/{userId}/budgets/{budgetId}
       */
      match /budgets/{budgetId} {
         allow read, list, create, update, delete: if isOwner(userId)
            && (
                (request.method == 'create' && hasValidSubcollectionDataOnCreate(userId)) ||
                (request.method == 'update' && isSubcollectionDataImmutable()) ||
                (request.method in ['get', 'list', 'delete'])
            );
      }

      /**
       * @description Manages a user's personal bill reminders.
       * @path /users/{userId}/bills/{billId}
       */
      match /bills/{billId} {
         allow read, list, create, update, delete: if isOwner(userId)
            && (
                (request.method == 'create' && hasValidSubcollectionDataOnCreate(userId)) ||
                (request.method == 'update' && isSubcollectionDataImmutable()) ||
                (request.method in ['get', 'list', 'delete'])
            );
      }
    }
  }
}
